<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="MODTAG-52@@create-isfunctionexist-with-argcount-function" author="psmagin" runOnChange="true">
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION ISFUNCTIONEXIST(FUNCTIONNAME text, ARGCOUNT int)
            RETURNS boolean AS
            $BODY$
             BEGIN
             RETURN (SELECT EXISTS
            	(SELECT P.OID
            		FROM PG_PROC P
            		JOIN PG_NAMESPACE N ON P.PRONAMESPACE = N.OID
            		WHERE N.NSPNAME like '%_mod_tags'
            			AND P.PRONAME = FUNCTIONNAME
            			AND P.PRONARGS = ARGCOUNT));
             END;
            $BODY$ LANGUAGE 'plpgsql';
        </sql>
    </changeSet>

    <changeSet id="MODTAG-52@@create-isfunctionexist-function" author="psmagin" runOnChange="true">
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION ISFUNCTIONEXIST(FUNCTIONNAME text)
            RETURNS boolean AS
            $BODY$
             BEGIN
             RETURN (SELECT EXISTS
            	(SELECT P.OID
            		FROM PG_PROC P
            		JOIN PG_NAMESPACE N ON P.PRONAMESPACE = N.OID
            		WHERE N.NSPNAME like '%_mod_tags'
            			AND P.PRONAME = FUNCTIONNAME));
             END;
            $BODY$ LANGUAGE 'plpgsql';
        </sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-rmb-job-table" author="psmagin" runOnChange="true">
        <sql dbms="postgresql">DROP TABLE IF EXISTS rmb_job</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-rmb-internal-table" author="psmagin" runOnChange="true">
        <sql dbms="postgresql">DROP TABLE IF EXISTS rmb_internal</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-rmb-internal-analyze-table" author="psmagin" runOnChange="true">
        <sql dbms="postgresql">DROP TABLE IF EXISTS rmb_internal_analyze</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-rmb-internal-index-table" author="psmagin" runOnChange="true">
        <sql dbms="postgresql">DROP TABLE IF EXISTS rmb_internal_index</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-tags_label_idx_unique-index" author="psmagin" runOnChange="true">
        <sql dbms="postgresql">DROP INDEX IF EXISTS tags_label_idx_unique</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-count_estimate_smart2-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('count_estimate_smart2');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS count_estimate_smart2</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-first_array_object_value-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('first_array_object_value');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS first_array_object_value</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-normalize_digits-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('normalize_digits');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS normalize_digits</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-count_estimate-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('count_estimate');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS count_estimate</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-concat_array_object-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('concat_array_object');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS concat_array_object</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-concat_array_object_values2-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('concat_array_object_values', 2);
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS concat_array_object_values (in jsonb_array jsonb, in field text)</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-concat_array_object_values4-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('concat_array_object_values', 4);
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS concat_array_object_values (in jsonb_array jsonb, in field text, in filterkey text, in filtervalue text)</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-tsquery_or-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('tsquery_or', 1);
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS tsquery_or (in text)</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-uuid_smaller-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('uuid_smaller');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS uuid_smaller CASCADE</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-count_estimate_default-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('count_estimate_default');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS count_estimate_default</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-next_uuid-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('next_uuid');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS next_uuid</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-uuid_larger-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('uuid_larger');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS uuid_larger CASCADE</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-tsquery_phrase-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('tsquery_phrase', 1);
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS tsquery_phrase (in text)</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-get_tsvector-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('get_tsvector');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS get_tsvector</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-rmb_internal_index-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('rmb_internal_index');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS rmb_internal_index</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-tsquery_and-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('tsquery_and', 1);
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS tsquery_and (in text)</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-concat_space_sql-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('concat_space_sql');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS concat_space_sql</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-set_id_in_jsonb-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('set_id_in_jsonb');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS set_id_in_jsonb CASCADE</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-tags_set_md-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('tags_set_md');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS tags_set_md CASCADE</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-set_tags_md_json-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('set_tags_md_json');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS set_tags_md_json CASCADE</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-f_unaccent-function" author="psmagin" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">
                SELECT ISFUNCTIONEXIST('f_unaccent');
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS f_unaccent</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-isfunctionexist-function" author="psmagin">
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS ISFUNCTIONEXIST(TEXT)</sql>
    </changeSet>

    <changeSet id="MODTAG-52@@drop-isfunctionexist-with-argcount-function" author="psmagin">
        <sql dbms="postgresql">DROP FUNCTION IF EXISTS ISFUNCTIONEXIST(TEXT, INT)</sql>
    </changeSet>
    
</databaseChangeLog>
